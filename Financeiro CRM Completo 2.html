<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LS Cilios - Sistema Completo</title>
    <!-- Biblioteca de Gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #d4a5a5; /* Ros√™ Gold */
            --primary-dark: #b58585;
            --bg: #f4f7f6;
            --white: #ffffff;
            --text: #2c3e50;
            --green: #27ae60;
            --red: #c0392b;
            --blue: #2980b9;
            --orange: #e67e22;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg); display: flex; height: 100vh; color: var(--text); overflow: hidden; }

        /* --- MENU LATERAL --- */
        aside {
            width: 310px; background: var(--white); padding: 20px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05); display: flex; flex-direction: column;
            overflow-y: auto; z-index: 2; border-right: 1px solid #eee;
        }

        .logo-circle {
            width: 70px; height: 70px; background: var(--primary); color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            font-size: 1.8rem; font-weight: bold; margin: 0 auto 10px;
            border: 3px solid #fff; outline: 2px solid var(--primary); box-shadow: 0 4px 10px rgba(212,165,165,0.3);
        }

        h3 { font-size: 0.9rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 20px;}

        .form-group { margin-bottom: 12px; }
        label { font-size: 0.75rem; font-weight: 700; color: #95a5a6; display: block; margin-bottom: 4px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; box-sizing: border-box; font-size: 0.9rem; }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #fffafb; }
        
        button { cursor: pointer; transition: 0.2s; border: none; border-radius: 6px; font-weight: bold; }
        .btn-lancar { background: var(--text); color: white; padding: 12px; width: 100%; margin-top: 5px; }
        .btn-lancar:hover { background: var(--primary); }
        
        .btn-excel { 
            background: #219150; color: white; padding: 10px; width: 100%; margin-top: auto; 
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-excel:hover { background: #1e8449; }

        /* --- √ÅREA PRINCIPAL --- */
        main { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        /* 1. CARDS TOTAIS */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); text-align: center; border-left: 5px solid transparent; }
        .card.in { border-left-color: var(--green); }
        .card.out { border-left-color: var(--red); }
        .card.bal { border-left-color: var(--blue); }
        .card .valor { font-size: 1.6rem; font-weight: bold; margin-top: 5px; }

        /* 2. LINHA DO MEIO: CONTAS A PAGAR + TERM√îMETRO */
        .planning-row { display: flex; gap: 20px; flex-wrap: wrap; }
        
        /* Box Contas (Esquerda) */
        .bills-box { 
            flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; flex-direction: column;
        }
        .bill-input-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .bill-list { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; max-height: 160px; }
        .bill-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 8px; border-bottom: 1px solid #f1f2f6; font-size: 0.9rem;
        }
        .btn-pay { background: var(--green); color: white; padding: 4px 8px; font-size: 0.7rem; margin-left: 10px; border-radius: 4px; }
        .btn-del-mini { background: #ff7675; color: white; width: 20px; height: 20px; border-radius: 50%; font-size: 0.7rem; line-height: 20px; padding: 0; }

        /* Box Term√¥metro (Direita) */
        .goal-box {
            flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); display: flex; flex-direction: column; justify-content: center; text-align: center;
        }
        .progress-container {
            height: 25px; background: #dfe6e9; border-radius: 15px; overflow: hidden; position: relative; margin: 15px 0;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, var(--orange), var(--green));
            width: 0%; transition: width 1s ease-in-out;
        }
        .progress-text {
            position: absolute; width: 100%; top: 4px; font-size: 0.8rem; font-weight: bold; color: #2d3436; text-shadow: 0 0 2px rgba(255,255,255,0.8);
        }

        /* 3. GR√ÅFICOS */
        .charts-row { display: flex; gap: 20px; flex-wrap: wrap; }
        .chart-card { 
            flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); height: 320px;
        }

        /* 4. TABELA */
        .table-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #b2bec3; font-size: 0.8rem; padding-bottom: 10px; border-bottom: 2px solid #eee; }
        td { padding: 10px 0; border-bottom: 1px solid #f9f9f9; font-size: 0.9rem; }
        .tag { padding: 3px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; }
        .tag.servico { background: #e3f2fd; color: #2196f3; }
        .tag.fixo { background: #ffebee; color: #c0392b; }
        .tag.material { background: #fff3e0; color: #e67e22; }

        @media (max-width: 800px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            aside { width: 100%; box-sizing: border-box; }
            .charts-row, .planning-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <aside>
        <div class="logo-circle">LS</div>
        <div style="text-align:center; color:var(--primary); margin-bottom:10px;"><b>LS Cilios</b></div>

        <!-- FORMUL√ÅRIO R√ÅPIDO -->
        <h3>‚ö° Novo Lan√ßamento</h3>
        <div class="form-group">
            <label>Descri√ß√£o</label>
            <input type="text" id="desc" placeholder="Ex: Manuten√ß√£o...">
        </div>
        <div class="form-group">
            <label>Tipo</label>
            <select id="tipo" onchange="toggleCliente()">
                <option value="entrada">üí∞ Entrada (Ganho)</option>
                <option value="saida">üí∏ Sa√≠da (Gasto)</option>
            </select>
        </div>
        
        <!-- CLIENTE (S√≥ aparece se for Entrada) -->
        <div class="form-group" id="box-cliente">
            <label>Cliente</label>
            <div style="display:flex; gap:5px;">
                <select id="selCliente"><option value="">Avulso</option></select>
                <button onclick="addCliente()" style="background:var(--primary); color:white; width:35px;">+</button>
            </div>
        </div>

        <div class="form-group">
            <label>Categoria</label>
            <select id="cat">
                <option value="Servi√ßo">Servi√ßo</option>
                <option value="Material">Material</option>
                <option value="Fixo">Custo Fixo (Aluguel/Luz)</option>
                <option value="Pessoal">Pessoal / Sal√°rio</option>
                <option value="Outros">Outros</option>
            </select>
        </div>
        <div class="form-group">
            <label>Valor (R$)</label>
            <input type="number" id="valor" step="0.01">
        </div>
        <button class="btn-lancar" onclick="lancarCaixa()">REGISTRAR</button>

        <!-- EXPORTAR -->
        <button class="btn-excel" onclick="exportarExcel()">
            üì• Baixar Excel
        </button>
        <p style="text-align:center; margin-top:10px;">
            <a href="#" onclick="limparTudo()" style="color:#ccc; font-size:0.75rem; text-decoration:none;">Resetar Sistema</a>
        </p>
    </aside>

    <main>
        <!-- 1. TOTAIS -->
        <div class="cards-grid">
            <div class="card in">
                <span style="color:var(--green); font-size:0.8rem; font-weight:bold;">FATURAMENTO</span>
                <div class="valor" id="v-entrada">R$ 0,00</div>
            </div>
            <div class="card out">
                <span style="color:var(--red); font-size:0.8rem; font-weight:bold;">DESPESAS TOTAIS</span>
                <div class="valor" id="v-saida">R$ 0,00</div>
            </div>
            <div class="card bal">
                <span style="color:var(--blue); font-size:0.8rem; font-weight:bold;">SALDO L√çQUIDO</span>
                <div class="valor" id="v-saldo">R$ 0,00</div>
            </div>
        </div>

        <!-- 2. PLANEJAMENTO (CONTAS E METAS) -->
        <div class="planning-row">
            <!-- Lista de Boletos Futuros -->
            <div class="bills-box">
                <h3 style="margin-top:0; color:var(--text)">üìÖ Contas a Pagar (Futuro)</h3>
                <div class="bill-input-row">
                    <input type="text" id="contaDesc" placeholder="Conta (Ex: Aluguel)" style="flex:2">
                    <input type="number" id="contaValor" placeholder="Valor" style="flex:1">
                    <button onclick="addConta()" style="background:var(--text); color:white; width:30px;">+</button>
                </div>
                <ul id="lista-contas" class="bill-list"></ul>
            </div>

            <!-- Term√¥metro de Cobertura -->
            <div class="goal-box">
                <h3 style="margin-top:0; color:var(--text)">üå°Ô∏è Cobertura de Custos Fixos</h3>
                <p style="font-size:0.8rem; color:#888; margin:0;">Quanto do faturamento cobre suas contas fixas.</p>
                
                <div class="progress-container">
                    <div class="progress-bar" id="barra-progresso"></div>
                    <div class="progress-text" id="texto-progresso">0%</div>
                </div>
                
                <div id="msg-meta" style="font-weight:bold; font-size:0.9rem; color:var(--primary);">
                    Aguardando dados...
                </div>
                <div style="font-size:0.8rem; color:#aaa; margin-top:5px;">
                    Meta (Contas Cadastradas): <span id="valor-meta">R$ 0,00</span>
                </div>
            </div>
        </div>

        <!-- 3. GR√ÅFICOS LADO A LADO -->
        <div class="charts-row">
            <!-- Pizza: Gastos -->
            <div class="chart-card">
                <h3 style="margin-top:0; text-align:center;">üçï Para onde vai o dinheiro?</h3>
                <div style="height:250px; position:relative;">
                    <canvas id="chartPizza"></canvas>
                </div>
            </div>
            <!-- Barras: Top Clientes -->
            <div class="chart-card">
                <h3 style="margin-top:0; text-align:center;">üèÜ Top 5 Clientes</h3>
                <div style="height:250px; position:relative;">
                    <canvas id="chartBarra"></canvas>
                </div>
            </div>
        </div>

        <!-- 4. TABELA -->
        <div class="table-box">
            <h3>Extrato Financeiro</h3>
            <table id="tabela">
                <thead><tr><th>Descri√ß√£o</th><th>Categoria</th><th>Valor</th><th></th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

<script>
    // --- DADOS ---
    let transacoes = JSON.parse(localStorage.getItem('ls_final_trans')) || [];
    let contas = JSON.parse(localStorage.getItem('ls_final_contas')) || [];
    let clientes = JSON.parse(localStorage.getItem('ls_final_clientes')) || [];
    let chartP = null;
    let chartB = null;

    // --- INICIALIZA√á√ÉO ---
    window.onload = function() {
        atualizarSelectClientes();
        renderizarContas();
        atualizarTela();
    };

    // --- FUN√á√ïES DE LAN√áAMENTO (CAIXA) ---
    function lancarCaixa() {
        let desc = document.getElementById('desc').value;
        let tipo = document.getElementById('tipo').value;
        let valor = parseFloat(document.getElementById('valor').value);
        let cat = document.getElementById('cat').value;
        let cli = document.getElementById('selCliente').value;

        if(!desc || isNaN(valor)) { alert("Preencha descri√ß√£o e valor!"); return; }
        if(tipo === 'saida') cli = ''; 

        transacoes.push({ id: Date.now(), data: new Date().toLocaleDateString('pt-BR'), desc, tipo, valor, cat, cliente: cli });
        salvar();
        atualizarTela();
        
        document.getElementById('desc').value = '';
        document.getElementById('valor').value = '';
    }

    function deletar(id) {
        if(confirm("Apagar este lan√ßamento?")) {
            transacoes = transacoes.filter(t => t.id !== id);
            salvar();
            atualizarTela();
        }
    }

    // --- FUN√á√ïES DE CONTAS A PAGAR (FUTURO) ---
    function addConta() {
        let desc = document.getElementById('contaDesc').value;
        let valor = parseFloat(document.getElementById('contaValor').value);

        if(!desc || isNaN(valor)) { alert("Preencha a conta e o valor!"); return; }

        contas.push({ id: Date.now(), desc, valor });
        salvar();
        renderizarContas();
        atualizarTela(); // Atualiza a meta no term√¥metro

        document.getElementById('contaDesc').value = '';
        document.getElementById('contaValor').value = '';
    }

    function pagarConta(id) {
        let conta = contas.find(c => c.id === id);
        if(confirm(`Confirmar pagamento de ${conta.desc}?`)) {
            // Lan√ßa no caixa como sa√≠da
            transacoes.push({
                id: Date.now(),
                data: new Date().toLocaleDateString('pt-BR'),
                desc: conta.desc,
                tipo: 'saida',
                valor: conta.valor,
                cat: 'Fixo', // Assume Fixo
                cliente: ''
            });
            // Remove da lista de pendentes
            contas = contas.filter(c => c.id !== id);
            
            salvar();
            renderizarContas();
            atualizarTela();
        }
    }

    function removerConta(id) {
        if(confirm("Excluir conta pendente?")) {
            contas = contas.filter(c => c.id !== id);
            salvar();
            renderizarContas();
            atualizarTela();
        }
    }

    function renderizarContas() {
        const lista = document.getElementById('lista-contas');
        lista.innerHTML = '';
        contas.forEach(c => {
            let li = document.createElement('li');
            li.className = 'bill-item';
            li.innerHTML = `
                <span><b>${c.desc}</b> <br> R$ ${c.valor.toFixed(2)}</span>
                <div>
                    <button class="btn-del-mini" onclick="removerConta(${c.id})">x</button>
                    <button class="btn-pay" onclick="pagarConta(${c.id})">‚úÖ Pagar</button>
                </div>
            `;
            lista.appendChild(li);
        });
    }

    // --- FUN√á√ïES DE CLIENTES ---
    function addCliente() {
        let nome = prompt("Nome da Cliente:");
        if(nome) {
            clientes.push(nome);
            clientes.sort();
            salvar();
            atualizarSelectClientes();
            document.getElementById('selCliente').value = nome;
        }
    }

    function atualizarSelectClientes() {
        let sel = document.getElementById('selCliente');
        sel.innerHTML = '<option value="">Avulso</option>';
        clientes.forEach(c => {
            let opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            sel.appendChild(opt);
        });
    }

    function toggleCliente() {
        let tipo = document.getElementById('tipo').value;
        document.getElementById('box-cliente').style.display = (tipo === 'entrada') ? 'block' : 'none';
    }

    // --- EXCEL ---
    function exportarExcel() {
        let csv = 'Data;Descricao;Tipo;Categoria;Valor;Cliente\n';
        transacoes.forEach(t => {
            csv += `${t.data};${t.desc};${t.tipo};${t.cat};${t.valor.toString().replace('.', ',')};${t.cliente}\n`;
        });
        let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        let url = URL.createObjectURL(blob);
        let link = document.createElement("a");
        link.href = url;
        link.download = "LSCilios_Financeiro.csv";
        link.click();
    }

    // --- ATUALIZA√á√ÉO GERAL E GR√ÅFICOS ---
    function atualizarTela() {
        const tbody = document.querySelector('#tabela tbody');
        tbody.innerHTML = '';
        
        let ent = 0, sai = 0;
        let gastosPorCat = {};
        let rankingCli = {};

        // Processar transa√ß√µes
        transacoes.sort((a,b) => b.id - a.id).forEach(t => {
            if(t.tipo === 'entrada') {
                ent += t.valor;
                if(t.cliente) rankingCli[t.cliente] = (rankingCli[t.cliente] || 0) + t.valor;
            } else {
                sai += t.valor;
                gastosPorCat[t.cat] = (gastosPorCat[t.cat] || 0) + t.valor;
            }

            // Tabela
            let tr = document.createElement('tr');
            let tagClass = t.cat.toLowerCase();
            if(!['servi√ßo','material','fixo'].includes(tagClass)) tagClass = '';
            
            tr.innerHTML = `
                <td><b>${t.desc}</b><br><small style="color:#aaa">${t.data}</small></td>
                <td><span class="tag ${tagClass}">${t.cat}</span></td>
                <td style="color:${t.tipo==='entrada'?'var(--green)':'var(--red)'}">R$ ${t.valor.toFixed(2)}</td>
                <td><button class="btn-del-mini" style="background:#e74c3c" onclick="deletar(${t.id})">x</button></td>
            `;
            tbody.appendChild(tr);
        });

        // Totais
        document.getElementById('v-entrada').innerText = `R$ ${ent.toFixed(2)}`;
        document.getElementById('v-saida').innerText = `R$ ${sai.toFixed(2)}`;
        document.getElementById('v-saldo').innerText = `R$ ${(ent-sai).toFixed(2)}`;

        // L√ìGICA DO TERM√îMETRO (META)
        // Meta = Soma das contas pendentes + Soma do que j√° foi pago de Fixo
        // Assim, a meta n√£o diminui quando ela paga a conta, ela se mant√©m como refer√™ncia do m√™s.
        let totalFixoPago = transacoes.filter(t => t.cat === 'Fixo' && t.tipo === 'saida').reduce((acc, t) => acc + t.valor, 0);
        let totalPendente = contas.reduce((acc, c) => acc + c.valor, 0);
        let metaTotal = totalFixoPago + totalPendente;

        document.getElementById('valor-meta').innerText = `R$ ${metaTotal.toFixed(2)}`;

        if(metaTotal > 0) {
            let cobrindo = ent; // Faturamento total cobre os custos
            let porc = (cobrindo / metaTotal) * 100;
            if(porc > 100) porc = 100;
            
            document.getElementById('barra-progresso').style.width = `${porc}%`;
            document.getElementById('texto-progresso').innerText = `${porc.toFixed(0)}%`;
            
            let falta = metaTotal - cobrindo;
            if(falta > 0) {
                document.getElementById('msg-meta').innerHTML = `Falta <span style="color:var(--red)">R$ ${falta.toFixed(2)}</span> p/ cobrir custos fixos!`;
            } else {
                document.getElementById('msg-meta').innerHTML = `üéâ Custos Fixos Cobertos!`;
                document.getElementById('barra-progresso').style.background = "var(--green)";
            }
        } else {
            document.getElementById('barra-progresso').style.width = "0%";
            document.getElementById('msg-meta').innerText = "Cadastre contas para ver a meta.";
        }

        atualizarGraficos(gastosPorCat, rankingCli);
    }

    function atualizarGraficos(gastos, clientes) {
        // Pizza
        const ctxP = document.getElementById('chartPizza').getContext('2d');
        if(chartP) chartP.destroy();
        chartP = new Chart(ctxP, {
            type: 'doughnut',
            data: {
                labels: Object.keys(gastos),
                datasets: [{
                    data: Object.values(gastos),
                    backgroundColor: ['#e74c3c', '#3498db', '#f1c40f', '#9b59b6', '#95a5a6']
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        });

        // Barras
        const ctxB = document.getElementById('chartBarra').getContext('2d');
        if(chartB) chartB.destroy();
        
        // Top 5 Clientes
        let sortedCli = Object.entries(clientes).sort((a,b) => b[3] - a[3]).slice(0, 5);
        
        chartB = new Chart(ctxB, {
            type: 'bar',
            data: {
                labels: sortedCli.map(i => i),
                datasets: [{
                    label: 'Gasto Total',
                    data: sortedCli.map(i => i[3]),
                    backgroundColor: '#d4a5a5'
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function salvar() {
        localStorage.setItem('ls_final_trans', JSON.stringify(transacoes));
        localStorage.setItem('ls_final_contas', JSON.stringify(contas));
        localStorage.setItem('ls_final_clientes', JSON.stringify(clientes));
    }

    function limparTudo() {
        if(confirm("ATEN√á√ÉO: Isso apaga todos os dados. Continuar?")) {
            localStorage.clear();
            location.reload();
        }
    }
</script>

</body>
</html>